<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio de Viagem M√°gico ‚ú®</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@300;400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Lato', 'sans-serif'],
                        magic: ['Cinzel', 'serif'],
                        hand: ['Dancing Script', 'cursive']
                    },
                    colors: { 
                        'parchment': '#fdf6e3',
                        'parchment-dark': '#eee8d5',
                        'wizard-gold': '#d4af37',
                        'magic-blue': '#1e3a8a',
                        'spell-red': '#991b1b',
                        'potion-green': '#065f46',
                    },
                    boxShadow: {
                        'magical': '0 10px 15px -3px rgba(212, 175, 55, 0.3), 0 4px 6px -2px rgba(212, 175, 55, 0.1)',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Lato', sans-serif; 
            background-color: #fdf6e3; 
            color: #2c3e50;
            background-image: radial-gradient(#d4af37 0.5px, transparent 0.5px), radial-gradient(#d4af37 0.5px, #fdf6e3 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            background-attachment: fixed;
        }

        h1, h2, h3, .font-magic { font-family: 'Cinzel', serif; letter-spacing: 0.5px; }
        .font-hand { font-family: 'Dancing Script', cursive; }

        .card { 
            background: #fffef0; 
            border: 1px solid #e2d1c3;
            border-radius: 1rem; 
            box-shadow: 2px 4px 12px rgba(0,0,0,0.08);
            position: relative;
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, #d4af37, #fdf6e3, #d4af37);
            border-radius: 1rem 1rem 0 0;
            opacity: 0.7;
        }

        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 700; transition: all 0.3s; font-size: 0.85rem; cursor: pointer; text-transform: uppercase; font-family: 'Cinzel', serif; }
        .btn-primary { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; border: 1px solid #1e3a8a; box-shadow: 0 4px 6px rgba(30, 58, 138, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .btn-secondary { background: linear-gradient(135deg, #065f46 0%, #10b981 100%); color: white; }
        .btn-ghost { background: transparent; color: #574c43; border: 1px solid #d6c0b3; }
        .btn-ghost:hover { background: #f3e6d8; color: #2c3e50; }

        input, select, textarea { background-color: #fff; border: 1px solid #d4c5b5 !important; border-radius: 0.5rem !important; font-family: 'Lato', sans-serif; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #d4af37 !important; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2) !important; }

        .modal { position: fixed; inset: 0; background: rgba(26, 22, 37, 0.8); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { transform: scale(0.9); transition: transform 0.3s; border: 2px solid #d4af37; box-shadow: 0 0 20px rgba(212, 175, 55, 0.2); background: #fffef0; }
        .modal.active .modal-content { transform: scale(1); }

        .passport-stamp { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); border: 3px double #d4af37; border-radius: 50%; padding: 10px; color: #d4af37; font-family: 'Cinzel', serif; font-weight: 900; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0; pointer-events: none; transition: all 0.5s ease; z-index: 10; background: rgba(255, 254, 240, 0.9); box-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        .visited-active .passport-stamp { opacity: 1; transform: translate(-50%, -50%) rotate(-15deg) scale(1); }

        /* Timeline Styles */
        .timeline-container { position: relative; padding-left: 1.5rem; border-left: 2px dashed #cbd5e1; margin-left: 0.5rem; }
        .timeline-item { position: relative; margin-bottom: 1rem; }
        .timeline-dot { position: absolute; left: -1.9rem; top: 0.25rem; width: 0.8rem; height: 0.8rem; background: #fff; border: 2px solid #1e3a8a; border-radius: 50%; z-index: 2; }
        .timeline-dot.end { background: #1e3a8a; }

        .icon { width: 1.25rem; height: 1.25rem; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .sortable-ghost { opacity: 0.4; background: #d4af37; border: 2px dashed #1e3a8a; }
        .drag-handle { cursor: grab; user-select: none; }

        @media print {
            body { background: white; background-image: none; }
            .no-print, .btn, .modal { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; margin-bottom: 20px; }
        }
    </style>
</head>
<body class="pb-20">

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-6">
        <div class="text-center mt-20">
            <h1 class="text-2xl font-magic text-magic-blue">Carregando Magia...</h1>
        </div>
    </div>
    
    <div class="fixed bottom-2 right-2 no-print opacity-50 hover:opacity-100">
        <button onclick="hardReset()" class="text-[10px] text-gray-400 hover:text-red-500">Reset de Emerg√™ncia</button>
    </div>

    <div id="confirmModal" class="modal">
        <div class="card w-96 p-6 modal-content text-center">
            <h3 class="text-xl font-bold text-spell-red mb-2" id="confirmTitle">Tem certeza?</h3>
            <p class="text-gray-600 mb-6" id="confirmMsg">Essa a√ß√£o √© irrevers√≠vel.</p>
            <div class="flex justify-center gap-3">
                <button id="btnConfirmCancel" class="btn btn-ghost">Cancelar</button>
                <button id="btnConfirmOk" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="packingModal" class="modal">
        <div class="card w-full max-w-md p-6 modal-content max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b border-wizard-gold pb-2">
                <h3 class="text-xl font-magic text-magic-blue">Lista de Bagagem üß≥</h3>
                <button onclick="closeModal('packingModal')" class="text-2xl">√ó</button>
            </div>
            <form onsubmit="window.addPackingItem(event)" class="flex gap-2 mb-4">
                <input type="text" id="packItemInput" placeholder="Ex: Capa da Invisibilidade" class="w-full border rounded p-2" required>
                <button type="submit" class="btn btn-primary">+</button>
            </form>
            <ul id="packingListContainer" class="space-y-2"></ul>
        </div>
    </div>

    <div id="transportModal" class="modal">
        <div class="card w-full max-w-2xl p-6 modal-content m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-magic text-magic-blue">Expresso de Hogwarts üöÇ</h3>
                <button onclick="closeModal('transportModal')" class="text-2xl">√ó</button>
            </div>
            <div class="flex gap-4 mb-6 border-b border-wizard-gold/20 pb-4">
                <label class="flex items-center gap-2 cursor-pointer font-bold text-magic-blue"><input type="radio" name="tripType" value="one-way" checked onchange="toggleReturnSection()" class="accent-wizard-gold"> S√≥ Ida</label>
                <label class="flex items-center gap-2 cursor-pointer font-bold text-magic-blue"><input type="radio" name="tripType" value="round-trip" onchange="toggleReturnSection()" class="accent-wizard-gold"> Ida e Volta üîÅ</label>
            </div>
            <form onsubmit="window.saveTransportForm(event)" class="space-y-6">
                <div>
                    <h4 class="font-magic text-sm uppercase tracking-widest text-wizard-gold mb-2">Trajeto de Ida</h4>
                    <div id="outboundSegments" class="space-y-3"></div>
                    <button type="button" onclick="addSegment('outboundSegments')" class="mt-2 text-xs text-blue-600 hover:underline">+ Adicionar Conex√£o/Baldea√ß√£o</button>
                </div>
                <div id="returnSection" class="hidden border-t border-dashed border-gray-300 pt-4">
                    <h4 class="font-magic text-sm uppercase tracking-widest text-wizard-gold mb-2">Trajeto de Volta</h4>
                    <div id="inboundSegments" class="space-y-3"></div>
                    <button type="button" onclick="addSegment('inboundSegments')" class="mt-2 text-xs text-blue-600 hover:underline">+ Adicionar Conex√£o/Baldea√ß√£o</button>
                </div>
                <div class="bg-parchment p-4 rounded border border-wizard-gold/30 mt-4">
                    <label class="text-xs font-bold text-wizard-gold uppercase block mb-2">Custo Total</label>
                    <div class="flex gap-2 items-center">
                        <select id="transCostCurr" class="border rounded p-2 text-sm"><option value="BRL">R$</option><option value="USD">$</option><option value="EUR">‚Ç¨</option><option value="GBP">¬£</option></select>
                        <input type="number" step="0.01" id="transCostVal" placeholder="0.00" class="w-32 border rounded p-2 text-sm">
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" onclick="closeModal('transportModal')" class="btn btn-ghost">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Bilhete</button>
                </div>
            </form>
        </div>
    </div>

    <div id="attractionModal" class="modal">
        <div class="card w-full max-w-lg p-6 modal-content m-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-magic mb-4 text-magic-blue">Nova Atra√ß√£o ‚ú®</h3>
            <form onsubmit="window.saveAttractionForm(event)" class="space-y-4">
                <input type="text" id="attName" placeholder="Nome do Local" required class="w-full border rounded p-2 font-bold">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="attHours" placeholder="Hor√°rio (ex: 14:00)" class="w-full border rounded p-2">
                    <input type="text" id="attAddress" placeholder="Endere√ßo" class="w-full border rounded p-2">
                </div>
                <textarea id="attDesc" rows="3" placeholder="Descri√ß√£o M√°gica..." class="w-full border rounded p-2"></textarea>
                <div class="bg-parchment p-4 rounded border border-wizard-gold/30">
                    <label class="text-xs font-bold text-wizard-gold uppercase block mb-2">Custos</label>
                    <ul id="attCostsList" class="space-y-2 mb-3 text-sm"></ul>
                    <div class="flex gap-2 items-end">
                        <input type="text" id="newCostName" placeholder="Item" class="w-full border rounded p-1 text-sm">
                        <select id="newCostCurr" class="border rounded p-1 text-sm"><option value="BRL">R$</option><option value="USD">$</option><option value="EUR">‚Ç¨</option><option value="GBP">¬£</option></select>
                        <input type="number" step="0.01" id="newCostVal" placeholder="0.00" class="w-24 border rounded p-1 text-sm">
                        <button type="button" onclick="window.addTempCost()" class="btn btn-secondary py-1 px-3">+</button>
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" onclick="closeModal('attractionModal')" class="btn btn-ghost">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIG & UTILS ---
        const ICONS = {
            home: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>`,
            save: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>`,
            back: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>`,
            edit: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>`,
            trash: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>`,
            plus: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>`,
            money: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
            bag: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>`,
            train: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 19H5V8h14m-3-5v2a2 2 0 002 2h2v10h-2a2 2 0 00-2 2v2H8v-2a2 2 0 00-2-2H4V7h2a2 2 0 002-2V3h8zM8 12h8m-8 4h8"/></svg>`,
            map: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>`,
            search: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>`,
            scroll: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>`
        };

        const escapeHTML = (str) => String(str || '').replace(/[&<>'"]/g, t => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[t]));
        const showToast = (msg, type = 'success') => Toastify({ text: msg, duration: 3000, gravity: "top", position: "center", backgroundColor: type === 'error' ? "#991b1b" : "#d4af37", stopOnFocus: true }).showToast();
        const uuid = () => Math.random().toString(36).substr(2, 9);
        const fmtDate = (d) => { if(!d) return ''; const p = d.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; };
        
        let confirmCallback = null;
        window.askConfirm = (title, msg, callback) => {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMsg').textContent = msg;
            confirmCallback = callback;
            document.getElementById('confirmModal').classList.add('active');
        };
        document.getElementById('btnConfirmOk').onclick = () => { if(confirmCallback) confirmCallback(); document.getElementById('confirmModal').classList.remove('active'); };
        document.getElementById('btnConfirmCancel').onclick = () => document.getElementById('confirmModal').classList.remove('active');
        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        
        // Reset de Emerg√™ncia para casos de erro
        window.hardReset = () => { 
            if(confirm("Isso apagar√° todos os dados e resetar√° o app. Continuar?")) { 
                localStorage.clear(); 
                location.reload(); 
            } 
        };

        // --- STATE ---
        let appData = { trips: [] };
        let appState = { currentPage: 'home', currentTripId: null, currentDayId: null, tripSubView: null, history: [] };
        let tempAttractionCosts = [], currentEditingId = null;
        const currencies = [ { code: 'BRL', symbol: 'R$' }, { code: 'USD', symbol: '$' }, { code: 'EUR', symbol: '‚Ç¨' }, { code: 'GBP', symbol: '¬£' } ];

        window.saveData = () => localStorage.setItem('tripPlannerMagic', JSON.stringify(appData));
        window.loadData = () => {
            try {
                let json = localStorage.getItem('tripPlannerMagic') || localStorage.getItem('tripPlannerV5');
                if (json) {
                    appData = JSON.parse(json);
                    appData.trips.forEach(t => {
                        if (!t.packingList) t.packingList = [];
                        t.days.forEach(d => { if (!d.transport) d.transport = []; });
                    });
                }
            } catch (e) { console.error(e); }
        };

        window.navigate = (page, tripId = null, dayId = null, subView = null) => {
            appState.history.push({ ...appState });
            if (appState.history.length > 10) appState.history.shift();
            appState.currentPage = page; appState.currentTripId = tripId; appState.currentDayId = dayId; appState.tripSubView = (page === 'tripDetail') ? subView : null;
            window.renderApp();
        };

        window.goBack = () => {
            if (appState.history.length === 0) return window.navigate('home');
            const prev = appState.history.pop();
            Object.assign(appState, prev);
            window.renderApp();
        };

        // --- RENDER ---
        window.renderApp = () => {
            try {
                const app = document.getElementById('app');
                app.innerHTML = '';
                if (appState.currentPage === 'home') renderHome(app);
                else if (appState.currentPage === 'addEditTrip') renderAddEditTrip(app);
                else if (appState.currentPage === 'tripDetail') renderTripDetail(app);
                else if (appState.currentPage === 'dayDetail') renderDayDetail(app);
            } catch (err) {
                console.error("Erro ao renderizar:", err);
                document.getElementById('app').innerHTML = `<div class="text-center p-10 text-red-600"><h2 class="text-2xl font-bold">Erro M√°gico</h2><p>${err.message}</p><button onclick="hardReset()" class="btn btn-danger mt-4">Resetar Dados</button></div>`;
            }
        };

        function renderHeader(title) {
            return `<div class="flex justify-between items-center mb-6 sticky top-0 bg-[#fdf6e3]/95 backdrop-blur z-40 py-3 border-b border-wizard-gold/30 no-print">
                <div class="flex items-center gap-3"><button onclick="${appState.history.length ? 'goBack()' : "navigate('home')"}" class="p-2 rounded-full hover:bg-parchment-dark text-magic-blue transition">${ICONS.back}</button>${title ? `<h1 class="text-lg font-magic text-magic-blue truncate max-w-[200px] md:max-w-md">${escapeHTML(title)}</h1>` : ''}</div>
                <div class="flex gap-2 text-sm"><button onclick="navigate('home')" class="p-2 hover:text-magic-blue transition" title="Home">${ICONS.home}</button><button onclick="exportJson()" class="p-2 hover:text-magic-blue transition" title="Backup">${ICONS.save}</button></div>
            </div>`;
        }

        function renderHome(c) {
            const trips = appData.trips || [];
            const nextTrip = trips.filter(t => new Date(t.startDate) >= new Date()).sort((a,b) => new Date(a.startDate) - new Date(b.startDate))[0];
            
            let html = `<div class="animate-fade-in"><div class="flex justify-between items-center mb-8 no-print"><h1 class="text-3xl font-magic text-magic-blue">Meus Mapas M√°gicos üó∫Ô∏è</h1><label class="text-xs text-wizard-gold cursor-pointer hover:underline uppercase tracking-widest font-bold">Importar Pergaminho<input type="file" onchange="importJson(event)" class="hidden"></label></div>`;
            
            if (nextTrip) {
                const daysLeft = Math.ceil((new Date(nextTrip.startDate) - new Date()) / (1000 * 60 * 60 * 24));
                const bgStyle = nextTrip.coverUrl ? `background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7)), url('${nextTrip.coverUrl}'); background-size: cover; background-position: center;` : `background: linear-gradient(135deg, #1e3a8a, #4338ca);`;
                html += `<div onclick="navigate('tripDetail', '${nextTrip.id}')" style="${bgStyle}" class="rounded-xl p-8 text-white shadow-magical mb-10 cursor-pointer transform hover:scale-[1.01] transition no-print border border-wizard-gold relative overflow-hidden group">
                    <div class="relative z-10 text-center"><p class="text-wizard-gold text-sm font-bold uppercase tracking-[0.3em] mb-2 font-magic">Pr√≥xima Aventura</p><h2 class="text-4xl font-magic font-bold mb-2 text-white drop-shadow-lg">${escapeHTML(nextTrip.destination)}</h2><p class="text-xl font-hand opacity-90 text-yellow-100">A magia come√ßa em ${daysLeft} dias</p></div>
                </div>`;
            }
            
            html += `<div class="flex justify-between items-center mb-4 no-print border-b border-wizard-gold/30 pb-2"><h3 class="font-magic text-xl text-gray-700">Todos os Destinos</h3><button onclick="navigate('addEditTrip')" class="btn btn-primary text-sm">${ICONS.plus} Criar Roteiro</button></div><div class="grid md:grid-cols-2 gap-6">`;
            
            if(trips.length === 0) html += `<p class="col-span-2 text-center text-gray-400 italic py-10">Nenhum pergaminho encontrado. Crie sua primeira aventura!</p>`;

            trips.forEach(t => { 
                const cover = t.coverUrl ? `<div class="h-32 w-full bg-cover bg-center rounded-t-lg" style="background-image: url('${t.coverUrl}')"></div>` : '';
                html += `<div onclick="navigate('tripDetail', '${t.id}')" class="card cursor-pointer hover:shadow-magical transition group">${cover}<div class="p-5"><div class="flex justify-between items-start"><div><h3 class="font-magic font-bold text-xl text-magic-blue group-hover:text-wizard-gold transition">${escapeHTML(t.name)}</h3><p class="text-sm text-gray-600">${escapeHTML(t.destination)}</p></div><span class="text-xs bg-parchment-dark text-gray-600 px-2 py-1 rounded font-mono border border-gray-300">${fmtDate(t.startDate)}</span></div><button onclick="event.stopPropagation(); deleteTrip('${t.id}')" class="absolute bottom-4 right-4 text-gray-400 hover:text-spell-red transition no-print">${ICONS.trash}</button></div></div>`; 
            });
            c.innerHTML = html + `</div></div>`;
        }

        function renderAddEditTrip(c) {
            const tid = appState.currentTripId;
            const t = tid ? appData.trips.find(x => x.id === tid) : { fixedCosts: [], exchangeRates: {} };
            c.innerHTML = `${renderHeader(tid ? 'Editar Pergaminho' : 'Novo Roteiro')}
            <div class="card p-6 animate-fade-in max-w-2xl mx-auto"><form onsubmit="window.submitTripForm(event)" data-id="${tid || ''}" class="space-y-4"><div class="grid md:grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 uppercase">Nome da Aventura</label><input type="text" name="name" value="${escapeHTML(t.name||'')}" required class="w-full border p-2"></div><div><label class="block text-xs font-bold text-gray-500 uppercase">Reino / Destino</label><input type="text" name="destination" value="${escapeHTML(t.destination||'')}" required class="w-full border p-2"></div><div><label class="block text-xs font-bold text-gray-500 uppercase">Data de Partida</label><input type="date" name="startDate" value="${t.startDate||''}" required class="w-full border p-2"></div><div><label class="block text-xs font-bold text-gray-500 uppercase">Data de Retorno</label><input type="date" name="endDate" value="${t.endDate||''}" required class="w-full border p-2"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase">URL da Capa (Imagem)</label><input type="url" name="coverUrl" placeholder="https://..." value="${escapeHTML(t.coverUrl||'')}" class="w-full border p-2"></div></div><div class="border-t border-wizard-gold/30 pt-4 mt-6"><h3 class="font-magic mb-3 text-magic-blue">Cofre de Gringotts (Finan√ßas)</h3><div class="grid md:grid-cols-2 gap-4 mb-4"><div><label class="block text-xs font-bold text-gray-500 uppercase">Moeda Principal</label><select name="mainCurrency" id="mainCurrencySelect" class="w-full border p-2">${currencies.map(curr=>`<option value="${curr.code}" ${(t.mainCurrency||'BRL')===curr.code?'selected':''}>${curr.code} (${curr.symbol})</option>`).join('')}</select></div><div><label class="block text-xs font-bold text-gray-500 uppercase">Or√ßamento Total</label><input type="number" step="0.01" name="expectedBudget" value="${t.expectedBudget||0}" class="w-full border p-2"></div></div></div><button type="submit" class="btn btn-primary w-full py-3 mt-4 justify-center">Salvar Magia ‚ú®</button></form></div>`;
        }

        function renderTripDetail(c) {
            const tid = appState.currentTripId;
            const t = appData.trips.find(x => x.id === tid);
            if (!t) return window.navigate('home');
            
            if (appState.tripSubView === 'budget') {
                c.innerHTML = `${renderHeader(t.name)}<div class="card p-6 animate-fade-in max-w-4xl mx-auto"><h2 class="text-2xl font-magic mb-6 text-magic-blue flex items-center gap-2">${ICONS.money} Relat√≥rio do Tesouro</h2><div class="grid md:grid-cols-2 gap-8 items-center"><div class="h-64 relative"><canvas id="budgetChart"></canvas></div><div id="budgetStats" class="space-y-4"></div></div></div>`;
                setTimeout(() => renderBudgetChart(t), 100);
                return;
            }

            let html = `${renderHeader(t.name)}
            <div class="mb-8 flex flex-col md:flex-row justify-between items-end gap-4 border-b border-wizard-gold/30 pb-4">
                <div><h2 class="text-4xl font-magic font-bold text-magic-blue">${escapeHTML(t.destination)}</h2><p class="text-gray-500 font-hand text-xl mt-1">${fmtDate(t.startDate)} a ${fmtDate(t.endDate)}</p></div>
                <div class="flex gap-2 no-print flex-wrap"><button onclick="window.openPackingModal()" class="btn btn-ghost hover:bg-yellow-50 text-wizard-gold border-wizard-gold">${ICONS.bag} Malas</button><button onclick="navigate('tripDetail','${tid}',null,'budget')" class="btn btn-ghost">üí∞ Finan√ßas</button><button onclick="navigate('addEditTrip','${tid}')" class="btn btn-ghost">‚öô Editar</button></div>
            </div>
            <p class="text-xs text-center text-gray-400 mb-2 uppercase tracking-widest no-print">Arraste os cart√µes usando o √≠cone <span class="text-xl leading-none">‚ãÆ‚ãÆ</span> para reordenar</p>
            <div id="daysListContainer" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 pb-10">`;
            
            t.days.forEach((d, i) => {
                const allVisited = d.attractions.length > 0 && d.attractions.every(a => a.visited);
                html += `<div data-id="${d.id}" class="card p-5 hover:bg-[#fffef8] transition duration-300 group border-l-4 ${allVisited ? 'border-l-potion-green' : 'border-l-wizard-gold'} relative">
                    <div class="drag-handle absolute top-2 right-2 text-wizard-gold/50 hover:text-wizard-gold p-2 cursor-grab text-2xl leading-none" title="Arrastar para reordenar">‚ãÆ‚ãÆ</div>
                    <div onclick="navigate('dayDetail', '${tid}', '${d.id}')" class="cursor-pointer pr-8">
                        <div class="flex justify-between items-center mb-2"><h4 class="font-magic font-bold text-gray-800 text-lg">Dia ${i+1}</h4><span class="text-sm font-hand text-gray-500">${d.dateText}</span></div>
                        <div class="space-y-1 mb-2">${d.attractions.slice(0,3).map(a => `<div class="text-sm text-gray-600 truncate flex items-center gap-2"><span class="text-[10px] ${a.visited?'text-green-600':'text-gray-300'}">‚ú¶</span> ${escapeHTML(a.name)}</div>`).join('')}${d.attractions.length > 3 ? `<div class="text-xs text-gray-400 italic">+${d.attractions.length-3} locais</div>` : ''}</div>
                        <p class="text-xs text-right text-gray-400 mt-2">${fmtDate(d.date)}</p>
                    </div>
                </div>`;
            });
            c.innerHTML = html + `</div>`;
            const el = document.getElementById('daysListContainer');
            if(el) Sortable.create(el, { animation: 200, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: function(evt) { const ids = Array.from(el.children).map(c => c.dataset.id); window.reorderDays(tid, ids); }});
        }

        function renderDayDetail(c) {
            const tid = appState.currentTripId, did = appState.currentDayId;
            const t = appData.trips.find(x => x.id === tid), d = t.days.find(x => x.id === did);
            const transport = d.transport || [];
            const kmlUrl = d.kmlUrl || '';

            // Helper Timeline
            const renderTimeline = (segments, label) => {
                if(!segments || segments.length === 0) return '';
                let html = `<div class="mb-4"><h5 class="text-xs font-bold text-wizard-gold uppercase mb-2">${label}</h5><div class="timeline-container">`;
                segments.forEach((seg, idx) => {
                    html += `<div class="timeline-item"><div class="timeline-dot"></div><div class="text-sm"><span class="font-bold text-gray-800">${escapeHTML(seg.from)}</span><span class="text-xs bg-gray-100 px-1 rounded mx-1">${escapeHTML(seg.time)}</span><div class="text-xs text-gray-500 italic pl-1 my-1 border-l-2 border-dotted border-gray-300">‚¨á ${escapeHTML(seg.duration)} ‚Ä¢ ${escapeHTML(seg.method||'Transporte')}</div></div></div>`;
                    if(idx === segments.length-1) html += `<div class="timeline-item"><div class="timeline-dot end"></div><div class="text-sm font-bold text-gray-800">${escapeHTML(seg.to)}</div></div>`;
                });
                return html + `</div></div>`;
            };

            c.innerHTML = `${renderHeader(t.destination)}
            <div class="max-w-4xl mx-auto mb-20 space-y-6">
                <div class="card p-6 animate-fade-in">
                    <div class="flex justify-between items-start border-b border-wizard-gold/20 pb-4 mb-4">
                        <div><div class="flex items-center gap-3"><h2 class="text-3xl font-magic font-bold text-magic-blue">${escapeHTML(d.dateText)}</h2><button onclick="window.editDayTitle('${d.id}')" class="text-gray-400 hover:text-wizard-gold no-print">${ICONS.edit}</button></div><p class="text-gray-500 font-hand text-xl">${fmtDate(d.date)}</p></div>
                        <div id="weather-icon-${d.id}" class="text-2xl text-right min-w-[80px]"></div>
                    </div>
                    <div class="flex gap-2 items-center bg-parchment p-3 rounded border border-wizard-gold/30">
                        <div class="flex-grow">${d.city ? `<div class="flex items-center gap-2 text-magic-blue font-bold">üìç ${escapeHTML(d.city)} <button onclick="resetCity('${d.id}')" class="text-xs text-red-400 underline ml-2">(Alterar)</button></div>` : `<div class="flex gap-2"><input type="text" id="cityInput" placeholder="Cidade (ex: Orlando)" class="p-1 text-sm border rounded w-full"><button onclick="searchCity('${d.id}')" class="btn btn-sm btn-secondary text-xs p-1 px-3">${ICONS.search}</button></div>`}</div>
                        ${d.lat ? `<a href="https://www.google.com/maps/search/?api=1&query=${d.lat},${d.lng}" target="_blank" class="btn btn-sm btn-primary text-xs no-print">${ICONS.map} Mapa</a>` : ''}
                    </div>
                </div>

                <div class="card p-4 border border-wizard-gold bg-[#fffef8]">
                    <details ${kmlUrl ? 'open' : ''}>
                        <summary class="cursor-pointer font-magic text-wizard-gold font-bold flex items-center gap-2 select-none">${ICONS.scroll} Mapa do Maroto (KML/Embed)</summary>
                        <div class="mt-4 animate-fade-in">
                            <div class="flex gap-2 mb-2 no-print">
                                <input type="text" id="kmlInput" value="${escapeHTML(kmlUrl)}" placeholder="Cole o link do Google My Maps ou KML..." class="w-full text-sm border p-2 rounded">
                                <button onclick="saveKmlUrl('${d.id}')" class="btn btn-sm btn-secondary text-xs">Carregar</button>
                            </div>
                            <div class="text-xs text-gray-500 mb-2 italic px-1">Dica: Se usar Google My Maps, certifique-se que est√° p√∫blico ("Qualquer pessoa com link").</div>
                            <div id="mapContainer-${d.id}" class="w-full h-96 bg-gray-100 rounded border-4 border-wizard-gold overflow-hidden relative">
                                ${kmlUrl ? renderKmlFrame(kmlUrl) : '<div class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm italic p-4 text-center">Cole o link do mapa para visualizar.</div>'}
                            </div>
                        </div>
                    </details>
                </div>

                <div class="card p-6 border-l-4 border-l-blue-400">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-magic text-xl text-blue-900 flex items-center gap-2">${ICONS.train} Expresso de Hogwarts</h3><button onclick="openTransportModal()" class="text-xs btn btn-ghost border-blue-200 text-blue-800 hover:bg-blue-50">+ Bilhete</button></div>
                    <div id="transportList" class="space-y-4">
                        ${transport.length === 0 ? '<p class="text-gray-400 text-sm italic">Nenhum deslocamento m√°gico agendado.</p>' : ''}
                        ${transport.map(tr => `
                            <div class="bg-white p-4 rounded border border-blue-100 shadow-sm relative overflow-hidden">
                                <button onclick="deleteTransport('${tr.id}')" class="absolute top-2 right-2 text-red-300 hover:text-red-500">√ó</button>
                                <div class="flex items-center gap-2 mb-3"><span class="text-2xl">üéüÔ∏è</span><span class="font-bold text-blue-900 text-lg">${tr.type === 'round-trip' ? 'Ida e Volta' : 'S√≥ Ida'}</span>${tr.cost ? `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-bold ml-auto mr-6">${tr.cost.currency} ${tr.cost.value}</span>` : ''}</div>
                                <div class="grid md:grid-cols-2 gap-4">${renderTimeline(tr.outbound, 'IDA ‚û°Ô∏è')}${tr.type === 'round-trip' ? renderTimeline(tr.inbound, 'VOLTA ‚¨ÖÔ∏è') : ''}</div>
                            </div>`).join('')}
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6"><h3 class="font-magic text-xl text-gray-800">Roteiro M√°gico</h3><button onclick="openAttractionModal()" class="btn btn-secondary shadow-lg hover:shadow-green-200">${ICONS.plus} Nova Atra√ß√£o</button></div>
                    <div id="attractionList" class="space-y-4 min-h-[50px]">
                        ${d.attractions.map(a => `
                        <div data-id="${a.id}" class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition relative group ${a.visited ? 'visited-active' : ''}">
                            <div class="passport-stamp">VISITADO</div>
                            <div class="flex justify-between items-start relative z-10">
                                <div class="w-full"><h4 class="font-bold text-lg text-gray-800 ${a.visited?'opacity-50':''}">${escapeHTML(a.name)}</h4>${a.hours ? `<p class="text-xs text-gray-500 font-bold mb-1">üïí ${escapeHTML(a.hours)}</p>` : ''}<p class="text-gray-600 text-sm whitespace-pre-line mt-2 italic font-serif">${escapeHTML(a.description || '')}</p></div>
                                <div class="flex flex-col gap-2 no-print opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="toggleVisited('${a.id}')" class="p-2 ${a.visited?'bg-green-100 text-green-700':'bg-gray-100 text-gray-400'} rounded-full hover:bg-green-200 transition">‚úî</button>
                                    <button onclick="openAttractionModal('${a.id}')" class="p-2 bg-blue-50 text-blue-500 rounded-full hover:bg-blue-100 transition">${ICONS.edit}</button>
                                    <button onclick="deleteAttraction('${a.id}')" class="p-2 bg-red-50 text-red-500 rounded-full hover:bg-red-100 transition">${ICONS.trash}</button>
                                </div>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>

                <div class="bg-parchment p-4 rounded-lg border border-wizard-gold/40 relative">
                    <span class="absolute -top-3 left-4 bg-parchment border border-wizard-gold text-wizard-gold px-2 text-xs font-bold uppercase tracking-widest">Di√°rio de Bordo</span>
                    <textarea class="w-full bg-transparent border-none focus:ring-0 text-gray-700 font-hand text-lg min-h-[100px] outline-none" placeholder="Escreva suas mem√≥rias aqui..." onblur="updateDayField('notes', this.value)">${escapeHTML(d.notes||'')}</textarea>
                </div>
            </div>`;
            
            const el = document.getElementById('attractionList');
            if(el) Sortable.create(el, { animation: 150, onEnd: function() { const ids = Array.from(el.children).map(c => c.dataset.id); d.attractions = ids.map(id => d.attractions.find(a => a.id === id)); saveData(); }});
            if(d.lat && d.lng) window.loadWeather(d.lat, d.lng, d.date, `weather-icon-${d.id}`);
        }

        // --- KML & MAP LOGIC (Link Converter) ---
        window.saveKmlUrl = (dayId) => {
            const val = document.getElementById('kmlInput').value.trim();
            const d = appData.trips.find(t=>t.id===appState.currentTripId).days.find(x=>x.id===dayId);
            d.kmlUrl = val; 
            saveData(); 
            window.renderDayDetail(document.getElementById('app'));
        };

        window.renderKmlFrame = (url) => {
            let finalUrl = url.trim();
            // Google Maps
            if (finalUrl.includes('google.com/maps') && (finalUrl.includes('/edit') || finalUrl.includes('/viewer'))) {
                finalUrl = finalUrl.replace('/edit', '/embed').replace('/viewer', '/embed');
                if (!finalUrl.includes('?')) finalUrl += '?';
                if (!finalUrl.includes('mid=')) { /* tenta manter */ }
                return `<iframe src="${finalUrl}" width="100%" height="100%" style="border:0"></iframe>`;
            }
            // GitHub Raw KML
            if (finalUrl.includes('github.com') && finalUrl.includes('/blob/')) {
                finalUrl = finalUrl.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
            }
            // Generic KML Embed
            if (finalUrl.endsWith('.kml')) {
                const encoded = encodeURIComponent(finalUrl);
                return `<iframe src="https://maps.google.com/maps?q=${encoded}&t=k&z=13&ie=UTF8&iwloc=&output=embed" width="100%" height="100%" style="border:0"></iframe>`;
            }
            // Fallback Iframe (se o usuario ja colou um embed code ou outro link)
            return `<iframe src="${finalUrl}" width="100%" height="100%" style="border:0"></iframe>`;
        };

        // --- TRANSPORT WIZARD ---
        window.openTransportModal = () => { 
            document.getElementById('outboundSegments').innerHTML = ''; 
            document.getElementById('inboundSegments').innerHTML = ''; 
            addSegment('outboundSegments'); 
            document.getElementsByName('tripType')[0].checked = true; 
            toggleReturnSection(); 
            document.getElementById('transCostVal').value = ''; 
            openModal('transportModal'); 
        };

        window.toggleReturnSection = () => { 
            const isRoundTrip = document.querySelector('input[name="tripType"]:checked').value === 'round-trip'; 
            const sec = document.getElementById('returnSection'); 
            if(isRoundTrip) { 
                sec.classList.remove('hidden'); 
                if(document.getElementById('inboundSegments').children.length === 0) addSegment('inboundSegments'); 
            } else { 
                sec.classList.add('hidden'); 
            } 
        };

        window.addSegment = (containerId) => {
            const container = document.getElementById(containerId); 
            const div = document.createElement('div');
            div.className = "grid grid-cols-2 md:grid-cols-4 gap-2 bg-gray-50 p-2 rounded border border-gray-200 relative";
            div.innerHTML = `
                <input type="text" placeholder="De (Origem)" class="seg-from w-full border rounded p-1 text-sm">
                <input type="time" class="seg-time w-full border rounded p-1 text-sm">
                <input type="text" placeholder="Dura√ß√£o (ex: 2h)" class="seg-dur w-full border rounded p-1 text-sm">
                <input type="text" placeholder="Para (Destino)" class="seg-to w-full border rounded p-1 text-sm">
                <input type="text" placeholder="Tipo (Trem/Voo)" class="seg-method col-span-2 md:col-span-4 w-full border rounded p-1 text-xs mt-1">
                ${container.children.length > 0 ? `<button type="button" onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-100 text-red-500 rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-200">√ó</button>` : ''}
            `;
            container.appendChild(div);
        };

        window.saveTransportForm = (e) => {
            e.preventDefault(); 
            const type = document.querySelector('input[name="tripType"]:checked').value;
            const extractSegments = (cid) => Array.from(document.getElementById(cid).children).map(div => ({ 
                from: div.querySelector('.seg-from').value, 
                time: div.querySelector('.seg-time').value, 
                duration: div.querySelector('.seg-dur').value, 
                to: div.querySelector('.seg-to').value, 
                method: div.querySelector('.seg-method').value 
            })).filter(s => s.from && s.to);
            
            const outbound = extractSegments('outboundSegments'); 
            const inbound = type === 'round-trip' ? extractSegments('inboundSegments') : [];
            const costVal = parseFloat(document.getElementById('transCostVal').value); 
            const costCurr = document.getElementById('transCostCurr').value;
            
            const newTransport = { 
                id: uuid(), 
                type: type, 
                outbound: outbound, 
                inbound: inbound, 
                cost: costVal ? { value: costVal, currency: costCurr } : null 
            };
            
            const d = appData.trips.find(t=>t.id===appState.currentTripId).days.find(x=>x.id===appState.currentDayId); 
            if(!d.transport) d.transport = []; 
            d.transport.push(newTransport);
            saveData(); 
            closeModal('transportModal'); 
            window.renderApp();
        };

        window.deleteTransport = (tid) => { 
            window.askConfirm('Rasgar Bilhete?', 'Isso remover√° este transporte.', () => { 
                const d = appData.trips.find(t=>t.id===appState.currentTripId).days.find(x=>x.id===appState.currentDayId); 
                d.transport = d.transport.filter(t => t.id !== tid); 
                saveData(); 
                window.renderApp(); 
            }); 
        };

        // --- CORE LOGIC ---
        window.searchCity = async (dayId) => { 
            const input = document.getElementById('cityInput'); 
            if(!input.value) return; 
            try { 
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(input.value)}&count=1&language=pt&format=json`); 
                const data = await res.json(); 
                if(data.results && data.results.length > 0) { 
                    const loc = data.results[0]; 
                    const d = appData.trips.find(t=>t.id===appState.currentTripId).days.find(x=>x.id===dayId); 
                    d.lat = loc.latitude; 
                    d.lng = loc.longitude; 
                    d.city = loc.name + `, ${loc.country_code}`; 
                    saveData(); 
                    window.renderDayDetail(document.getElementById('app')); 
                    showToast('Localiza√ß√£o M√°gica encontrada!'); 
                } else { 
                    showToast('Cidade n√£o encontrada.', 'error'); 
                } 
            } catch(e) { 
                showToast('Erro na esfera de vidro (API).', 'error'); 
            } 
        };

        window.resetCity = (dayId) => { 
            const d = appData.trips.find(t=>t.id===appState.currentTripId).days.find(x=>x.id===dayId); 
            d.city = null; d.lat = null; d.lng = null; 
            saveData(); 
            window.renderDayDetail(document.getElementById('app')); 
        };

        window.loadWeather = async (lat, lng, date, elId) => { 
            const el = document.getElementById(elId); 
            if(!el) return; 
            try { 
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&start_date=${date}&end_date=${date}`); 
                const data = await res.json(); 
                if(data.daily) { 
                    const c = data.daily.weathercode[0]; 
                    const icon = c===0?'‚òÄÔ∏è':(c<3?'‚õÖ':(c<60?'‚òÅÔ∏è':'üåßÔ∏è')); 
                    el.innerHTML = `${icon} <span class="text-sm block">${Math.round(data.daily.temperature_2m_min[0])}¬∞/${Math.round(data.daily.temperature_2m_max[0])}¬∞</span>`; 
                } 
            } catch(e){} 
        };

        window.openAttractionModal = (aid = null) => { 
            currentEditingId = aid; 
            const d = appData.trips.find(t=>t.id===appState.currentTripId).days.find(x=>x.id===appState.currentDayId); 
            let item = { name: '', description: '', hours: '', address: '', costs: [] }; 
            if(aid) item = d.attractions.find(a => a.id === aid); 
            document.getElementById('attName').value = item.name; 
            document.getElementById('attDesc').value = item.description || ''; 
            document.getElementById('attHours').value = item.hours || ''; 
            document.getElementById('attAddress').value = item.address || ''; 
            tempAttractionCosts = JSON.parse(JSON.stringify(item.costs || [])); 
            renderTempAttractionCosts(); 
            openModal('attractionModal'); 
        };

        window.saveAttractionForm = (e) => { 
            e.preventDefault(); 
            const d = appData.trips.find(t=>t.id===appState.currentTripId).days.find(x=>x.id===appState.currentDayId); 
            const newItem = { 
                id: currentEditingId || uuid(), 
                name: document.getElementById('attName').value, 
                description: document.getElementById('attDesc').value, 
                hours: document.getElementById('attHours').value, 
                address: document.getElementById('attAddress').value, 
                costs: tempAttractionCosts, 
                visited: currentEditingId ? d.attractions.find(a=>a.id===currentEditingId).visited : false 
            }; 
            if(currentEditingId) Object.assign(d.attractions.find(a => a.id === currentEditingId), newItem); 
            else d.attractions.push(newItem); 
            saveData(); 
            closeModal('attractionModal'); 
            window.renderApp(); 
        };

        window.openPackingModal = () => { 
            const t = appData.trips.find(x => x.id === appState.currentTripId); 
            renderPackingList(t); 
            openModal('packingModal'); 
        };

        function renderPackingList(t) { 
            document.getElementById('packingListContainer').innerHTML = (t.packingList || []).map((item, i) => `
                <li class="flex justify-between items-center bg-white p-2 rounded border border-gray-200">
                    <label class="flex items-center gap-2 cursor-pointer select-none flex-grow">
                        <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="togglePackItem(${i})" class="accent-wizard-gold">
                        <span class="${item.checked ? 'line-through text-gray-400' : 'text-gray-700'}">${escapeHTML(item.text)}</span>
                    </label>
                    <button onclick="deletePackItem(${i})" class="text-red-400 hover:text-red-600 px-2">√ó</button>
                </li>
            `).join(''); 
        }

        window.addPackingItem = (e) => { 
            e.preventDefault(); 
            const input = document.getElementById('packItemInput'); 
            const t = appData.trips.find(x => x.id === appState.currentTripId); 
            if(!t.packingList) t.packingList = []; 
            t.packingList.push({ text: input.value, checked: false }); 
            saveData(); 
            renderPackingList(t); 
            input.value = ''; 
        };

        window.togglePackItem = (i) => { 
            const t = appData.trips.find(x => x.id === appState.currentTripId); 
            t.packingList[i].checked = !t.packingList[i].checked; 
            saveData(); 
            renderPackingList(t); 
        };

        window.deletePackItem = (i) => { 
            const t = appData.trips.find(x => x.id === appState.currentTripId); 
            t.packingList.splice(i, 1); 
            saveData(); 
            renderPackingList(t); 
        };

        window.renderBudgetChart = (t) => { 
            const ctx = document.getElementById('budgetChart'); 
            if(!ctx) return; 
            let costs = { 'Transporte': 0, 'Atra√ß√µes': 0, 'Comida': 0, 'Hospedagem': 0, 'Outros': 0 }; 
            t.fixedCosts.forEach(c => costs['Transporte'] += c.amount); 
            t.days.forEach(d => { 
                d.attractions.forEach(a => { 
                    if(a.visited) a.costs.forEach(ac => costs['Atra√ß√µes'] += ac.value); 
                }); 
                (d.transport || []).forEach(tr => { 
                    if(tr.cost) costs['Transporte'] += tr.cost.value; 
                }); 
            }); 
            new Chart(ctx, { 
                type: 'doughnut', 
                data: { 
                    labels: Object.keys(costs), 
                    datasets: [{ 
                        data: Object.values(costs), 
                        backgroundColor: ['#1e3a8a', '#d4af37', '#065f46', '#991b1b', '#64748b'], 
                        borderWidth: 0 
                    }] 
                }, 
                options: { responsive: true, plugins: { legend: { position: 'right' } } } 
            }); 
            const total = Object.values(costs).reduce((a,b)=>a+b,0); 
            document.getElementById('budgetStats').innerHTML = `
                <div class="bg-gray-50 p-4 rounded border border-gray-200">
                    <p class="text-xs font-bold text-gray-500 uppercase">Total Gasto (Estimado)</p>
                    <p class="text-3xl font-bold text-gray-800">${total.toFixed(2)}</p>
                </div>
            `; 
        };

        window.submitTripForm = (e) => { 
            e.preventDefault(); 
            const f = e.target; 
            const tid = f.dataset.id; 
            let t = tid ? appData.trips.find(x => x.id === tid) : { id: uuid(), days: [], hotels: [], exchangeRates: [], packingList: [] }; 
            if(!tid) { 
                const d1 = new Date(f.startDate.value), d2 = new Date(f.endDate.value); 
                const count = (d2-d1)/(86400000) + 1; 
                for(let i=0; i<count; i++) { 
                    const d = new Date(d1); d.setDate(d1.getDate()+i); 
                    t.days.push({ id: uuid(), date: d.toISOString().split('T')[0], dateText: `Dia ${i+1}`, attractions: [], transport: [] }); 
                } 
                appData.trips.push(t); 
            } 
            t.name = f.name.value; t.destination = f.destination.value; t.startDate = f.startDate.value; t.endDate = f.endDate.value; t.coverUrl = f.coverUrl.value; t.mainCurrency = f.mainCurrency.value; t.expectedBudget = parseFloat(f.expectedBudget.value); 
            saveData(); 
            showToast('Magia salva!'); 
            navigate(tid ? 'tripDetail' : 'home', t.id); 
        };

        window.addTempCost = () => { 
            const n=document.getElementById('newCostName').value, v=parseFloat(document.getElementById('newCostVal').value), c=document.getElementById('newCostCurr').value; 
            if(n&&v){ 
                tempAttractionCosts.push({id:uuid(),name:n,value:v,currency:c}); 
                renderTempAttractionCosts(); 
                document.getElementById('newCostName').value=''; document.getElementById('newCostVal').value=''; 
            } 
        };

        window.removeTempCost = (i) => { 
            tempAttractionCosts.splice(i,1); 
            renderTempAttractionCosts(); 
        };

        window.renderTempAttractionCosts = () => { 
            document.getElementById('attCostsList').innerHTML = tempAttractionCosts.map((c,i)=>`
                <li class="flex justify-between text-xs bg-gray-50 p-1">
                    <span>${c.name}</span>
                    <span>${c.currency} ${c.value} <button onclick="removeTempCost(${i})" class="text-red-500 font-bold ml-2">x</button></span>
                </li>
            `).join(''); 
        };

        window.toggleVisited = (aid) => { 
            const d = appData.trips.find(t=>t.id===appState.currentTripId).days.find(x=>x.id===appState.currentDayId); 
            const a = d.attractions.find(x => x.id === aid); 
            a.visited = !a.visited; 
            saveData(); 
            window.renderApp(); 
        };

        window.deleteAttraction = (aid) => window.askConfirm('Remover?', 'Essa magia sumir√°.', () => { 
            const d = appData.trips.find(t=>t.id===appState.currentTripId).days.find(x=>x.id===appState.currentDayId); 
            d.attractions = d.attractions.filter(a => a.id !== aid); 
            saveData(); 
            window.renderApp(); 
        });

        window.deleteTrip = (id) => window.askConfirm('Queimar Roteiro?', 'Isso n√£o pode ser desfeito.', () => { 
            appData.trips = appData.trips.filter(t => t.id !== id); 
            saveData(); 
            renderHome(document.getElementById('app')); 
        });

        window.updateDayField = (f, v) => { 
            const d = appData.trips.find(t=>t.id===appState.currentTripId).days.find(x=>x.id===appState.currentDayId); 
            d[f] = v; 
            saveData(); 
        };

        window.editDayTitle = (did) => { 
            const d = appData.trips.find(t=>t.id===appState.currentTripId).days.find(x=>x.id===did); 
            const t = prompt("Novo t√≠tulo:", d.dateText); 
            if(t) { d.dateText = t; saveData(); window.renderApp(); } 
        };

        window.reorderDays = (tid, ids) => { 
            const t = appData.trips.find(x => x.id === tid); 
            t.days = ids.map(id => t.days.find(d => d.id === id)); 
            const s = new Date(t.startDate); 
            t.days.forEach((d,i) => { 
                const nd = new Date(s); nd.setDate(s.getDate()+i); 
                d.date = nd.toISOString().split('T')[0]; 
            }); 
            saveData(); 
            window.renderApp(); 
        };

        window.exportJson = () => { 
            const a = document.createElement('a'); 
            a.href = 'data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(appData)); 
            a.download = 'backup_magico.json'; 
            a.click(); 
        };

        window.importJson = (e) => { 
            const r = new FileReader(); 
            r.onload = ev => { 
                try { 
                    appData = JSON.parse(ev.target.result); 
                    saveData(); 
                    location.reload(); 
                } catch(err){ showToast('Erro no pergaminho', 'error'); } 
            }; 
            if(e.target.files[0]) r.readAsText(e.target.files[0]); 
        };

        window.onload = () => { 
            loadData(); 
            renderApp(); 
        };
    </script>
</body>
</html>