<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio M√°gico - Com Aeroporto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #fdf6e3; color: #1e3a8a; }
        .font-magic { font-family: 'Cinzel', serif; }
        .font-hand { font-family: 'Dancing Script', cursive; }
        .btn { padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: #1e3a8a; color: white; }
        .btn-success { background: #059669; color: white; }
        .btn-warning { background: #d97706; color: white; }
        .btn-ghost { background: transparent; border: 1px solid #ccc; color: #555; }
        .btn-gold { background: #d4af37; color: white; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(2px); }
        .modal.active { display: flex; }
        .hidden-input { display: none; }
        .timeline-item { position: relative; padding-left: 20px; border-left: 2px dashed #cbd5e1; margin-left: 5px; padding-bottom: 10px; }
        .timeline-dot { position: absolute; left: -6px; top: 0; width: 10px; height: 10px; background: #1e3a8a; border-radius: 50%; }
        .cost-item { display: flex; justify-content: space-between; padding: 6px; background: #f3f4f6; border-radius: 4px; margin-bottom: 4px; font-size: 0.85rem; align-items: center; }
        .tab-btn { padding: 10px; cursor: pointer; border-bottom: 2px solid transparent; width: 50%; text-align: center; }
        .tab-btn.active { border-bottom: 3px solid #1e3a8a; font-weight: bold; color: #1e3a8a; background: rgba(30, 58, 138, 0.05); }
        .attraction-img { height: 120px; min-width: 160px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; flex-shrink: 0; }
        .gallery-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 8px; scroll-behavior: smooth; }
        .gallery-container::-webkit-scrollbar { height: 6px; }
        .gallery-container::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 3px; }
        .journal-box { background: #fffef0; border: 1px solid #e2d1c3; font-family: 'Dancing Script', cursive; font-size: 1.2rem; line-height: 1.5; color: #4a4a4a; padding: 15px; border-radius: 8px; width: 100%; min-height: 150px; background-image: radial-gradient(#d4af37 0.5px, transparent 0.5px); background-size: 20px 20px; }
    </style>
</head>
<body class="p-4 pb-20">

    <div id="app" class="max-w-6xl mx-auto"></div>

    <div id="cityModal" class="modal">
        <div class="bg-white p-6 rounded-lg w-full max-w-md m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Selecionar Cidade üåç</h3>
                <button onclick="closeModals()" class="text-red-500 font-bold text-xl">√ó</button>
            </div>
            <div class="flex gap-2 mb-4">
                <input id="citySearchInput" placeholder="Digite a cidade..." class="w-full p-2 border rounded">
                <button onclick="searchCity()" class="btn btn-primary">üîç</button>
            </div>
            <div id="cityList" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <button onclick="closeModals()" class="w-full mt-4 p-2 bg-gray-200 rounded">Cancelar</button>
        </div>
    </div>

    <div id="attractionModal" class="modal">
        <div class="bg-white p-6 rounded-lg w-full max-w-lg m-4 max-h-[90vh] overflow-y-auto">
            <h3 id="attModalTitle" class="font-bold text-lg mb-4 text-magic-blue">Nova Atra√ß√£o ‚ú®</h3>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <div class="w-2/3">
                        <label class="text-xs font-bold text-gray-500 uppercase ml-1">Nome</label>
                        <input id="attName" placeholder="Ex: Torre Eiffel" class="w-full p-2 border rounded font-bold">
                    </div>
                    <div class="w-1/3">
                        <label class="text-xs font-bold text-gray-500 uppercase ml-1">Categoria</label>
                        <select id="attType" class="w-full p-2 border rounded bg-gray-50">
                            <option value="sight">üè∞ Passeio</option>
                            <option value="food">üçî Comida</option>
                            <option value="shop">üõçÔ∏è Compras</option>
                            <option value="hotel">üè® Hotel</option>
                            <option value="transport">üöå Transp.</option>
                            <option value="airport">‚úàÔ∏è Aeroporto</option>
                            <option value="other">‚ú® Outros</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <input id="attHours" placeholder="Hor√°rio (Ex: 14:00)" class="w-full p-2 border rounded">
                    <input id="attAddress" placeholder="Endere√ßo / Localiza√ß√£o" class="w-full p-2 border rounded">
                </div>
                
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Fotos (Links)</label>
                    <textarea id="attPhotos" rows="2" placeholder="Cole links das imagens (um por linha)..." class="w-full p-2 border rounded text-xs bg-gray-50 font-mono"></textarea>
                </div>
                <textarea id="attDesc" rows="3" placeholder="Descri√ß√£o, notas importantes..." class="w-full p-2 border rounded"></textarea>
                
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Custos (Ingressos)</label>
                    <ul id="attCostsList" class="mb-3"></ul>
                    <div class="flex gap-2 items-center">
                        <input id="newCostName" placeholder="Item" class="w-full p-1 text-sm border rounded">
                        <select id="newCostCurr" class="p-1 text-sm border rounded"><option value="BRL">R$</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select>
                        <input id="newCostVal" type="number" step="0.01" placeholder="0.00" class="w-24 p-1 text-sm border rounded">
                        <button type="button" onclick="addTempCost()" class="btn btn-success text-xs px-3">+</button>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6 border-t pt-4">
                <button onclick="closeModals()" class="btn bg-gray-200 text-gray-800">Cancelar</button>
                <button onclick="saveAttraction()" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <div id="transportModal" class="modal">
        <div class="bg-white p-6 rounded-lg w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg text-magic-blue mb-4">Expresso de Hogwarts üöÇ</h3>
            <div class="flex gap-4 mb-4 border-b pb-4">
                <label class="flex items-center gap-2 font-bold cursor-pointer"><input type="radio" name="tripType" value="one-way" checked onchange="toggleReturnSection()"> S√≥ Ida</label>
                <label class="flex items-center gap-2 font-bold cursor-pointer"><input type="radio" name="tripType" value="round-trip" onchange="toggleReturnSection()"> Ida e Volta</label>
            </div>
            <h4 class="font-bold text-sm text-gray-500 uppercase mb-2">Ida</h4>
            <div id="outboundSegments" class="space-y-2"></div>
            <button onclick="addSegment('outboundSegments')" class="text-xs text-blue-600 hover:underline mb-4">+ Conex√£o</button>
            <div id="returnSection" class="hidden border-t pt-4">
                <h4 class="font-bold text-sm text-gray-500 uppercase mb-2">Volta</h4>
                <div id="inboundSegments" class="space-y-2"></div>
                <button onclick="addSegment('inboundSegments')" class="text-xs text-blue-600 hover:underline mb-4">+ Conex√£o</button>
            </div>
            <div class="mt-4 border-t pt-4 flex justify-between items-center">
                <div class="flex gap-2">
                    <select id="transCurr" class="p-2 border rounded text-sm"><option value="BRL">R$</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select>
                    <input type="number" id="transCost" placeholder="Custo" class="border p-2 rounded w-32 text-sm">
                </div>
                <div class="flex gap-2">
                    <button onclick="closeModals()" class="btn btn-ghost">Cancelar</button>
                    <button onclick="saveTransport()" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="financeModal" class="modal">
        <div class="bg-white p-0 rounded-lg w-full max-w-4xl m-4 h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-xl text-green-800">Cofre do Tesouro üí∞</h3>
                <button onclick="closeModals()" class="text-2xl text-gray-500 hover:text-red-500">√ó</button>
            </div>
            <div class="flex border-b bg-white sticky top-0 z-10">
                <div class="tab-btn active" onclick="switchFinanceTab('report')">üìä Relat√≥rio & C√¢mbio</div>
                <div class="tab-btn" onclick="switchFinanceTab('costs')">üí∏ Custos Pr√©vios</div>
            </div>
            <div id="tab-report" class="p-6 overflow-y-auto flex-1 bg-gray-50">
                <div class="bg-white p-4 rounded border mb-6 shadow-sm">
                    <h4 class="font-bold text-sm text-gray-600 uppercase mb-2">Taxas de Convers√£o (Para R$)</h4>
                    <div class="flex gap-4 flex-wrap items-end">
                        <div><label class="text-xs block">USD</label><input type="number" id="rateUSD" class="border p-1 rounded w-20" placeholder="5.00" onchange="saveRates()"></div>
                        <div><label class="text-xs block">EUR</label><input type="number" id="rateEUR" class="border p-1 rounded w-20" placeholder="6.00" onchange="saveRates()"></div>
                        <div><label class="text-xs block">GBP</label><input type="number" id="rateGBP" class="border p-1 rounded w-20" placeholder="7.00" onchange="saveRates()"></div>
                    </div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-6">
                    <h4 class="font-bold text-blue-900 text-sm uppercase tracking-wider mb-2">Custos Fixos / J√° Pagos</h4>
                    <div id="reportSunkCosts" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h4 class="font-bold text-lg mb-4 text-center text-magic-blue border-b pb-2">Or√ßamento da Viagem (Dia a Dia)</h4>
                    <div id="reportTable" class="overflow-x-auto"></div>
                    <div id="reportGrandTotal" class="mt-4 p-4 bg-green-100 border border-green-300 rounded text-center font-bold text-green-900 text-lg"></div>
                </div>
            </div>
            <div id="tab-costs" class="p-6 overflow-y-auto flex-1 hidden">
                <h4 class="font-bold mb-4">Lan√ßar Custos Anteriores</h4>
                <div class="flex flex-wrap gap-2 mb-4 bg-green-50 p-4 rounded border">
                    <select id="initType" class="p-2 border rounded w-full md:w-auto">
                        <option value="Avi√£o">‚úàÔ∏è Avi√£o</option>
                        <option value="Trem">üöÇ Trem</option>
                        <option value="Cruzeiro">üö¢ Cruzeiro</option>
                        <option value="Hospedagem">üè® Hospedagem</option>
                        <option value="Outros">üì¶ Outros</option>
                    </select>
                    <input id="initDesc" placeholder="Descri√ß√£o..." class="flex-1 p-2 border rounded min-w-[200px]">
                    <select id="initCurr" class="p-2 border rounded w-24"><option value="BRL">R$</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select>
                    <input id="initVal" type="number" step="0.01" placeholder="Valor" class="w-28 p-2 border rounded">
                    <button onclick="addInitialCost()" class="btn btn-success">Adicionar</button>
                </div>
                <h4 class="font-bold mb-2">Lista de Registros</h4>
                <ul id="initialCostsList" class="space-y-2"></ul>
            </div>
        </div>
    </div>

    <div id="dayExtraModal" class="modal">
        <div class="bg-white p-6 rounded-lg w-full max-w-sm m-4">
            <h3 class="font-bold text-lg mb-4 text-green-700">Gasto Extra do Dia üí∏</h3>
            <input id="extraDesc" placeholder="O que? Onde? (Ex: Almo√ßo)" class="w-full p-2 border rounded mb-2">
            <div class="flex gap-2 mb-4">
                <select id="extraCurr" class="p-2 border rounded"><option value="BRL">R$</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select>
                <input id="extraVal" type="number" step="0.01" placeholder="Valor" class="w-full p-2 border rounded">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModals()" class="btn bg-gray-200 text-gray-800">Cancelar</button>
                <button onclick="saveDayExtra()" class="btn btn-success">Adicionar</button>
            </div>
        </div>
    </div>

    <div id="checklistModal" class="modal">
        <div class="bg-white p-6 rounded-lg w-full max-w-md m-4 max-h-[80vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4">Checklist Pr√©-Viagem ‚úÖ</h3>
            <form onsubmit="addCheckItem(event)" class="flex gap-2 mb-4">
                <input id="checkInput" placeholder="Ex: Comprar Seguro Viagem" class="w-full p-2 border rounded" required>
                <button class="btn btn-primary">+</button>
            </form>
            <ul id="checklistContainer" class="space-y-2"></ul>
            <div class="mt-4 text-center"><button onclick="closeModals()" class="btn btn-ghost text-xs">Fechar</button></div>
        </div>
    </div>

    <script>
        // --- DADOS E ESTADO ---
        let appData = { trips: [] };
        let currentState = { page: 'home', tripId: null, dayId: null };
        let currentEditingId = null;
        let tempAttractionCosts = [];

        // CONFIGURA√á√ÉO DE CATEGORIAS
        const categories = {
            sight: { icon: 'üè∞', color: 'bg-blue-100 text-blue-800 border-blue-200' },
            food: { icon: 'üçî', color: 'bg-rose-100 text-rose-800 border-rose-200' },
            shop: { icon: 'üõçÔ∏è', color: 'bg-amber-100 text-amber-800 border-amber-200' },
            hotel: { icon: 'üè®', color: 'bg-purple-100 text-purple-800 border-purple-200' },
            transport: { icon: 'üöå', color: 'bg-gray-100 text-gray-800 border-gray-200' },
            airport: { icon: '‚úàÔ∏è', color: 'bg-sky-100 text-sky-800 border-sky-200' },
            other: { icon: '‚ú®', color: 'bg-slate-100 text-slate-800 border-slate-200' }
        };

        // --- INICIALIZA√á√ÉO ---
        function init() {
            try {
                const json = localStorage.getItem('magic_planner_v4') || localStorage.getItem('magic_planner_v3');
                if (json) appData = JSON.parse(json);
                if(!appData.trips) appData.trips = [];
                appData.trips.forEach(t => {
                    if(!t.initialCosts) t.initialCosts = [];
                    if(!t.checklist) t.checklist = [];
                    if(!t.rates) t.rates = { USD: 0, EUR: 0, GBP: 0 };
                    if(!t.days) t.days = [];
                    t.days.forEach(d => {
                        if(!d.locations) d.locations = [];
                        if(!d.attractions) d.attractions = [];
                        if(!d.transport) d.transport = [];
                        if(!d.extraCosts) d.extraCosts = [];
                        if(typeof d.journal !== 'string') d.journal = '';
                        d.attractions.forEach(a => { 
                            if(!a.costs) a.costs = []; 
                            if(!a.photos) a.photos = a.photo ? [a.photo] : [];
                            if(!a.type) a.type = 'other';
                        });
                    });
                });
            } catch (e) { console.error("Erro ao carregar:", e); }
            render();
        }

        function saveData() { localStorage.setItem('magic_planner_v4', JSON.stringify(appData)); }

        // --- RENDERIZA√á√ÉO ---
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; 
            if (currentState.page === 'home') renderHome(app);
            else if (currentState.page === 'trip') renderTrip(app);
            else if (currentState.page === 'day') renderDay(app);
            else if (currentState.page === 'new') renderNewTrip(app);
        }

        // --- TELAS ---
        function renderHome(container) {
            let html = `
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b border-gray-300 pb-4">
                    <h1 class="text-3xl font-magic text-magic-blue">Meus Roteiros üìú</h1>
                    <div class="flex gap-2 flex-wrap justify-center">
                        <label class="btn btn-success shadow text-sm">üìÇ Importar <input type="file" onchange="importData(event)" class="hidden-input" accept=".json"></label>
                        <button onclick="exportData()" class="btn btn-warning shadow text-sm">üíæ Backup</button>
                        <button onclick="goTo('new')" class="btn btn-primary shadow text-sm">+ Novo</button>
                    </div>
                </div>
                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">`;
            if(appData.trips.length === 0) html += `<div class="col-span-3 text-center text-gray-400 p-10 border-2 dashed rounded-lg">Nenhum roteiro encontrado.</div>`;
            appData.trips.forEach(t => {
                html += `
                    <div onclick="openTrip('${t.id}')" class="card p-6 cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1 bg-yellow-50 relative group">
                        <h2 class="text-xl font-bold mb-1 text-magic-blue">${t.destination}</h2>
                        <p class="text-sm text-gray-600 font-bold mb-2">${t.name || 'Aventura'}</p>
                        <p class="text-xs text-gray-500">${t.startDate} ‚ûù ${t.endDate}</p>
                        <button onclick="event.stopPropagation(); deleteTrip('${t.id}')" class="absolute top-4 right-4 text-red-300 hover:text-red-600 font-bold p-2">üóë</button>
                    </div>`;
            });
            container.innerHTML = html + `</div>`;
        }

        function renderNewTrip(container) {
            container.innerHTML = `
                <div class="card p-8 max-w-lg mx-auto mt-10">
                    <h2 class="text-2xl font-magic mb-6 text-center">Nova Aventura</h2>
                    <input id="newName" class="w-full p-2 border rounded mb-3" placeholder="Nome da Viagem">
                    <input id="newDest" class="w-full p-2 border rounded mb-3" placeholder="Destino Principal">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <input id="newStart" type="date" class="w-full p-2 border rounded">
                        <input id="newEnd" type="date" class="w-full p-2 border rounded">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="createTrip()" class="btn btn-primary w-full justify-center">Criar</button>
                        <button onclick="goTo('home')" class="btn bg-gray-200 text-gray-800 w-full justify-center">Cancelar</button>
                    </div>
                </div>`;
        }

        function renderTrip(container) {
            const t = appData.trips.find(x => x.id === currentState.tripId);
            if(!t) return goTo('home');
            let html = `
                <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6 sticky top-0 bg-[#fdf6e3] z-10 py-2 border-b">
                    <div class="flex items-center gap-4">
                        <button onclick="goTo('home')" class="btn bg-white border shadow-sm">‚¨Ö Voltar</button>
                        <div><h1 class="text-2xl font-magic font-bold">${t.destination}</h1><p class="text-xs text-gray-500">${t.startDate} - ${t.endDate}</p></div>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="openChecklist()" class="btn btn-white border shadow text-gray-700 text-xs">‚úÖ Checklist</button>
                        <button onclick="generateICS()" class="btn btn-white border shadow text-blue-700 text-xs">üìÖ Agenda</button>
                        <button onclick="generatePDF()" class="btn btn-white border shadow text-red-700 text-xs">üìÑ PDF</button>
                        <button onclick="openFinanceModal()" class="btn btn-gold shadow font-bold text-green-900 border border-yellow-600 text-xs">üí∞ Finan√ßas</button>
                    </div>
                </div>
                <div id="daysGrid" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3 pb-10">`;

            t.days.forEach((d, index) => {
                const title = d.customTitle || `Dia ${index + 1}`;
                const locs = d.locations.map(l => l.name.split(',')[0]).join(' & ');
                html += `
                    <div data-id="${d.id}" onclick="openDay('${t.id}', '${d.id}')" class="card p-4 cursor-pointer hover:bg-blue-50 transition border-l-4 border-l-blue-800">
                        <div class="drag-handle absolute top-2 right-2 text-gray-400 hover:text-gray-600 p-1 cursor-move" title="Arrastar">‚ãÆ‚ãÆ</div>
                        <div class="flex justify-between items-start pr-6">
                            <h3 class="font-bold text-lg">${title}</h3>
                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">${formatDateBr(d.date)}</span>
                        </div>
                        <div class="mt-2 text-xs">
                            <span class="text-blue-600 font-bold">${d.attractions ? d.attractions.length : 0} atra√ß√µes</span>
                            ${d.extraCosts && d.extraCosts.length ? `<span class="text-green-600 font-bold ml-2">üí∏ ${d.extraCosts.length} gastos</span>` : ''}
                        </div>
                        ${locs ? `<p class="text-xs text-green-700 mt-1 truncate">üìç ${locs}</p>` : ''}
                    </div>`;
            });
            container.innerHTML = html + `</div>`;
            setTimeout(() => { const el = document.getElementById('daysGrid'); if(el) new Sortable(el, { animation: 150, handle: '.drag-handle', onEnd: (evt) => { const newOrderIds = Array.from(el.children).map(child => child.getAttribute('data-id')); reorderDays(newOrderIds); }}); }, 100);
        }

        function renderDay(container) {
            const t = appData.trips.find(x => x.id === currentState.tripId);
            const d = t.days.find(x => x.id === currentState.dayId);
            if(!d.extraCosts) d.extraCosts = [];
            const title = d.customTitle || `Dia ${t.days.indexOf(d) + 1}`;

            let locationsHtml = `<div class="bg-green-50 p-3 rounded border border-green-200 mb-4"><div class="flex justify-between items-center mb-2"><span class="font-bold text-green-900 text-sm uppercase">Destinos / Clima</span><button onclick="openCitySearch()" class="text-xs bg-green-200 text-green-900 px-2 py-1 rounded">+ Cidade</button></div><div class="space-y-2">`;
            if(d.locations && d.locations.length > 0) {
                d.locations.forEach((loc, idx) => {
                    locationsHtml += `<div class="flex justify-between items-center bg-white p-2 rounded border border-green-100"><div><span class="font-bold text-sm">${loc.name}</span><div id="weather-${loc.id}" class="text-xs text-gray-500">‚è≥ Clima...</div></div><div class="flex gap-2"><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.name)}" target="_blank" class="text-blue-500 text-xs font-bold">üó∫Ô∏è</a><button onclick="deleteLocation(${idx})" class="text-red-400 text-xs font-bold">√ó</button></div></div>`;
                    setTimeout(() => fetchWeather(loc.lat, loc.lng, d.date, `weather-${loc.id}`), 100);
                });
            } else { locationsHtml += `<div class="text-center text-gray-400 text-xs italic">Nenhuma cidade definida.</div>`; }
            locationsHtml += `</div></div>`;

            const mapHtml = `<div class="card p-4 mb-4 border-l-4 border-l-yellow-400 bg-white"><details ${d.kmlUrl ? 'open' : ''}><summary class="font-bold cursor-pointer text-yellow-700 flex items-center gap-2">üó∫Ô∏è Mapa do Maroto (Google Maps)</summary><div class="mt-2"><div class="flex gap-2 mb-2"><input id="kmlInput" value="${d.kmlUrl || ''}" placeholder="Cole link do Google Maps My Maps..." class="w-full text-xs p-2 border rounded"><button onclick="saveKml()" class="btn btn-xs bg-yellow-100 text-yellow-800 border">Salvar</button></div><div class="bg-gray-100 h-64 rounded border flex items-center justify-center overflow-hidden">${d.kmlUrl ? renderMapFrame(d.kmlUrl) : '<span class="text-gray-400 text-xs italic">Cole um link para ver o mapa</span>'}</div></div></details></div>`;

            let transportHtml = d.transport.map(tr => `<div class="bg-purple-50 p-3 rounded border border-purple-100 mb-2 relative group"><button onclick="deleteTransport('${tr.id}')" class="absolute top-2 right-2 text-red-300 hover:text-red-500 font-bold">√ó</button><div class="font-bold text-purple-900 text-sm mb-2">üöÇ ${tr.type === 'round-trip' ? 'Ida e Volta' : 'S√≥ Ida'} ${tr.cost ? ` - ${tr.currency} ${tr.cost}` : ''}</div><div class="text-xs">${renderTimeline(tr.outbound, 'IDA')}${tr.type === 'round-trip' ? renderTimeline(tr.inbound, 'VOLTA') : ''}</div></div>`).join('');

            let attractionsHtml = d.attractions.map(a => {
                const totalCost = (a.costs || []).reduce((acc, c) => acc + (parseFloat(c.value) || 0), 0);
                const costDisplay = totalCost > 0 ? `<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded ml-2">üí∞ ${totalCost.toFixed(2)}</span>` : '';
                let galleryHtml = '';
                if(a.photos && a.photos.length > 0) galleryHtml = `<div class="gallery-container">` + a.photos.map(p => `<img src="${p}" class="attraction-img" onerror="this.style.display='none'">`).join('') + `</div>`;
                
                const cat = categories[a.type || 'other'];
                const catBadge = `<span class="text-[10px] px-2 py-1 rounded-full border ${cat.color} mr-2">${cat.icon}</span>`;

                return `<div class="flex justify-between items-start p-3 bg-white border border-gray-100 rounded mb-2 shadow-sm"><div class="w-full">${galleryHtml}<div class="font-bold flex items-center ${a.visited ? 'line-through text-gray-400' : 'text-gray-800'}">${catBadge} ${a.name} ${costDisplay}</div>${a.hours ? `<div class="text-xs text-gray-500 font-bold">üïí ${a.hours}</div>` : ''}${a.description ? `<div class="text-xs text-gray-600 mt-1 italic border-l-2 pl-2">${a.description}</div>` : ''}</div><div class="flex gap-1 ml-2"><button onclick="toggleVisited('${a.id}')" class="text-green-500 hover:bg-green-100 p-2 rounded">‚úî</button><button onclick="openAttractionModal('${a.id}')" class="text-blue-500 hover:bg-blue-100 p-2 rounded">‚úèÔ∏è</button><button onclick="deleteAttraction('${a.id}')" class="text-red-400 hover:bg-red-50 p-2 rounded">üóë</button></div></div>`;
            }).join('');

            let extrasHtml = d.extraCosts.map((ex, i) => `<div class="flex justify-between items-center text-sm p-2 border-b border-dashed"><span>${ex.desc}</span><span class="font-mono font-bold text-green-700">${ex.currency} ${ex.value} <button onclick="deleteExtra(${i})" class="text-red-400 ml-2">√ó</button></span></div>`).join('');

            container.innerHTML = `
                <div class="max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="openTrip('${t.id}')" class="btn bg-white border">‚¨Ö Voltar</button>
                        <div class="text-right">
                            <h2 onclick="editDayTitle('${d.id}')" class="text-2xl font-magic text-magic-blue cursor-pointer hover:text-yellow-600 transition" title="Clique para editar">${title} ‚úèÔ∏è</h2>
                            <p class="text-gray-500">${formatDateBr(d.date)}</p>
                        </div>
                    </div>
                    ${locationsHtml} ${mapHtml}
                    <div class="card p-5 mb-4 bg-white border-l-4 border-l-purple-400"><div class="flex justify-between items-center mb-3"><h3 class="font-bold text-purple-900">Expresso de Hogwarts (Transporte)</h3><button onclick="openTransportModal()" class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded hover:bg-purple-200">+ Bilhete</button></div>${transportHtml || '<p class="text-gray-400 text-xs italic">Nenhum trem agendado.</p>'}</div>
                    <div class="card p-5 min-h-[150px] bg-white mb-4"><div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-lg text-magic-blue">Roteiro do Dia</h3><div><button onclick="moveUnvisited('${d.id}')" class="btn bg-orange-100 text-orange-800 text-xs mr-2">‚è© Adiar Pendentes</button><button onclick="openAttractionModal()" class="btn btn-primary text-xs">+ Atra√ß√£o</button></div></div>${attractionsHtml || '<p class="text-gray-400 italic text-center py-4">Nada planejado.</p>'}</div>
                    <div class="card p-5 bg-green-50 border border-green-200 mb-4"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-green-900">üí∏ Gastos Extras / Compras</h3><button onclick="openExtraModal()" class="text-xs bg-green-200 text-green-900 px-2 py-1 rounded">+ Novo</button></div><div class="bg-white rounded p-2 border">${extrasHtml || '<span class="text-xs text-gray-400 italic">Sem gastos extras.</span>'}</div></div>
                    <div class="mb-10"><h3 class="font-magic text-xl text-magic-blue mb-2">Di√°rio de Bordo ‚úçÔ∏è</h3><textarea class="journal-box" placeholder="Escreva aqui suas mem√≥rias, sentimentos e hist√≥rias do dia..." onblur="saveJournal('${d.id}', this.value)">${d.journal || ''}</textarea></div>
                </div>`;
        }

        // --- FUN√á√ïES NOVAS ---
        function moveUnvisited(dayId) {
            const t = appData.trips.find(x => x.id === currentState.tripId);
            const currentIdx = t.days.findIndex(d => d.id === dayId);
            if(currentIdx >= t.days.length - 1) return alert("Este √© o √∫ltimo dia!");
            if(!confirm("Mover pendentes para amanh√£?")) return;
            const currentDay = t.days[currentIdx];
            const nextDay = t.days[currentIdx + 1];
            const pending = currentDay.attractions.filter(a => !a.visited);
            const visited = currentDay.attractions.filter(a => a.visited);
            if(pending.length === 0) return alert("Nada pendente.");
            currentDay.attractions = visited;
            nextDay.attractions = [...nextDay.attractions, ...pending];
            saveData(); render();
        }
        function saveJournal(dayId, text) { const t = appData.trips.find(x => x.id === currentState.tripId); t.days.find(x => x.id === dayId).journal = text; saveData(); }
        function generateICS() {
            const t = appData.trips.find(x => x.id === currentState.tripId);
            let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//DiarioMagico//PT\n";
            t.days.forEach(d => {
                d.attractions.forEach(a => {
                    const dateStr = d.date.replace(/-/g, '');
                    let timeStr = "090000"; let desc = a.description || "";
                    if(a.hours) { const match = a.hours.match(/(\d{1,2}):(\d{2})/); if(match) timeStr = `${match[1].padStart(2,'0')}${match[2]}00`; else desc += ` (${a.hours})`; }
                    const startDT = `${dateStr}T${timeStr}`;
                    let endH = parseInt(timeStr.substr(0,2)) + 2;
                    const endDT = `${dateStr}T${endH.toString().padStart(2,'0')}${timeStr.substr(2)}`;
                    ics += `BEGIN:VEVENT\nDTSTART:${startDT}\nDTEND:${endDT}\nSUMMARY:${a.name}\nDESCRIPTION:${desc}\nLOCATION:${a.address||''}\nEND:VEVENT\n`;
                });
            });
            ics += "END:VCALENDAR";
            const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([ics], { type: 'text/calendar' })); link.download = `Agenda_${t.destination}.ics`; link.click();
        }

        // --- MANTEIGA (FUN√á√ïES EXISTENTES) ---
        function reorderDays(newOrderIds) {
            const t = appData.trips.find(x => x.id === currentState.tripId);
            t.days = newOrderIds.map(id => t.days.find(d => d.id === id));
            const start = new Date(t.startDate);
            t.days.forEach((d, index) => {
                const cur = new Date(start); cur.setDate(start.getDate() + index); d.date = cur.toISOString().split('T')[0];
                if (!d.customTitle || d.customTitle.startsWith('Dia ')) d.customTitle = `Dia ${index + 1}`;
            });
            saveData(); render();
        }
        function switchFinanceTab(tab) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); document.getElementById('tab-costs').classList.toggle('hidden', tab !== 'costs'); document.getElementById('tab-report').classList.toggle('hidden', tab !== 'report'); if(tab === 'report') renderReport(); }
        function addInitialCost() { const t = document.getElementById('initType').value; const d = document.getElementById('initDesc').value; const v = document.getElementById('initVal').value; const c = document.getElementById('initCurr').value; if(!d || !v) return alert("Preencha tudo"); const tr = appData.trips.find(x => x.id === currentState.tripId); tr.initialCosts.push({ id: Math.random().toString(36).substr(2, 9), type: t, desc: d, value: parseFloat(v), currency: c }); saveData(); document.getElementById('initDesc').value=''; document.getElementById('initVal').value=''; renderInitialCosts(); }
        function renderInitialCosts() { const t = appData.trips.find(x => x.id === currentState.tripId); document.getElementById('initialCostsList').innerHTML = t.initialCosts.map((c, i) => `<li class="flex justify-between items-center p-2 bg-white border rounded"><div><span class="font-bold text-sm bg-gray-200 px-1 rounded mr-2">${c.type}</span> ${c.desc}</div><div class="font-mono">${c.currency} ${c.value.toFixed(2)} <button onclick="deleteInitialCost(${i})" class="text-red-500 ml-2">√ó</button></div></li>`).join(''); }
        function deleteInitialCost(idx) { const t = appData.trips.find(x => x.id === currentState.tripId); t.initialCosts.splice(idx, 1); saveData(); renderInitialCosts(); }
        function openExtraModal() { document.getElementById('dayExtraModal').classList.add('active'); }
        function saveDayExtra() { const d = document.getElementById('extraDesc').value; const v = document.getElementById('extraVal').value; const c = document.getElementById('extraCurr').value; if(!d || !v) return alert("Preencha tudo"); const tr = appData.trips.find(x => x.id === currentState.tripId); const dy = tr.days.find(x => x.id === currentState.dayId); dy.extraCosts.push({ desc: d, value: parseFloat(v), currency: c }); saveData(); document.getElementById('extraDesc').value=''; document.getElementById('extraVal').value=''; closeModals(); render(); }
        function deleteExtra(idx) { const tr = appData.trips.find(x => x.id === currentState.tripId); const d = tr.days.find(x => x.id === currentState.dayId); d.extraCosts.splice(idx, 1); saveData(); render(); }
        function editDayTitle(dayId) { const t = appData.trips.find(x => x.id === currentState.tripId); const d = t.days.find(x => x.id === dayId); const newTitle = prompt("Novo t√≠tulo:", d.customTitle || `Dia ${t.days.indexOf(d) + 1}`); if (newTitle) { d.customTitle = newTitle; saveData(); render(); } }
        function openAttractionModal(aid = null) { currentEditingId = aid; const t = appData.trips.find(x => x.id === currentState.tripId); const d = t.days.find(x => x.id === currentState.dayId); if(aid) { const a = d.attractions.find(x => x.id === aid); document.getElementById('attName').value = a.name; document.getElementById('attType').value = a.type || 'other'; document.getElementById('attHours').value = a.hours || ''; document.getElementById('attAddress').value = a.address || ''; document.getElementById('attDesc').value = a.description || ''; document.getElementById('attPhotos').value = (a.photos || []).join('\n'); tempAttractionCosts = JSON.parse(JSON.stringify(a.costs || [])); document.getElementById('attModalTitle').innerText = "Editar Atra√ß√£o ‚úèÔ∏è"; } else { document.getElementById('attName').value = ''; document.getElementById('attHours').value = ''; document.getElementById('attAddress').value = ''; document.getElementById('attDesc').value = ''; document.getElementById('attPhotos').value = ''; tempAttractionCosts = []; document.getElementById('attModalTitle').innerText = "Nova Atra√ß√£o ‚ú®"; } renderTempCosts(); document.getElementById('attractionModal').classList.add('active'); }
        function addTempCost() { const n = document.getElementById('newCostName').value; const v = document.getElementById('newCostVal').value; const c = document.getElementById('newCostCurr').value; if(n && v) { tempAttractionCosts.push({ name: n, value: v, currency: c }); renderTempCosts(); document.getElementById('newCostName').value=''; document.getElementById('newCostVal').value=''; } }
        function removeTempCost(i) { tempAttractionCosts.splice(i, 1); renderTempCosts(); }
        function renderTempCosts() { document.getElementById('attCostsList').innerHTML = tempAttractionCosts.map((c, i) => `<li class="cost-item"><span>${c.name}</span><span>${c.currency} ${c.value} <button onclick="removeTempCost(${i})" class="text-red-500 font-bold ml-2">x</button></span></li>`).join(''); }
        function saveAttraction() { const n = document.getElementById('attName').value; if(!n) return alert("Nome necess√°rio"); const t = appData.trips.find(x => x.id === currentState.tripId); const d = t.days.find(x => x.id === currentState.dayId); const photos = document.getElementById('attPhotos').value.split('\n').map(p=>p.trim()).filter(p=>p); const data = { id: currentEditingId || Math.random().toString(36).substr(2, 9), name: n, type: document.getElementById('attType').value, hours: document.getElementById('attHours').value, address: document.getElementById('attAddress').value, description: document.getElementById('attDesc').value, photos: photos, costs: tempAttractionCosts, visited: currentEditingId ? d.attractions.find(a => a.id === currentEditingId).visited : false }; if(currentEditingId) d.attractions[d.attractions.findIndex(a => a.id === currentEditingId)] = data; else d.attractions.push(data); saveData(); closeModals(); render(); }
        function saveKml() { const v = document.getElementById('kmlInput').value; const t = appData.trips.find(x => x.id === currentState.tripId); const d = t.days.find(x => x.id === currentState.dayId); d.kmlUrl = v; saveData(); render(); }
        function renderMapFrame(url) { let f = url.trim(); if (f.includes('google.com/maps') && (f.includes('/edit') || f.includes('/viewer'))) f = f.replace('/edit', '/embed').replace('/viewer', '/embed'); return `<iframe src="${f}" width="100%" height="100%" style="border:0"></iframe>`; }
        function openTransportModal() { document.getElementById('outboundSegments').innerHTML = ''; document.getElementById('inboundSegments').innerHTML = ''; addSegment('outboundSegments'); document.getElementsByName('tripType')[0].checked = true; toggleReturnSection(); document.getElementById('transportModal').classList.add('active'); }
        function toggleReturnSection() { const isRound = document.querySelector('input[name="tripType"]:checked').value === 'round-trip'; document.getElementById('returnSection').classList.toggle('hidden', !isRound); if(isRound && document.getElementById('inboundSegments').children.length === 0) addSegment('inboundSegments'); }
        function addSegment(cid) { const div = document.createElement('div'); div.className = "grid grid-cols-2 gap-2 mb-2 p-2 bg-gray-100 rounded relative"; div.innerHTML = `<input placeholder="De" class="seg-from w-full p-1 border rounded"><input placeholder="Para" class="seg-to w-full p-1 border rounded"><input type="time" class="seg-time w-full p-1 border rounded"><input placeholder="Meio" class="seg-method w-full p-1 border rounded"><button onclick="this.parentElement.remove()" class="absolute -right-2 -top-2 bg-red-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">x</button>`; document.getElementById(cid).appendChild(div); }
        function saveTransport() { const type = document.querySelector('input[name="tripType"]:checked').value; const getSegs = (id) => Array.from(document.getElementById(id).children).map(d => ({ from: d.querySelector('.seg-from').value, to: d.querySelector('.seg-to').value, time: d.querySelector('.seg-time').value, method: d.querySelector('.seg-method').value })).filter(s => s.from && s.to); const newItem = { id: Math.random().toString(36).substr(2, 9), type, cost: document.getElementById('transCost').value, currency: document.getElementById('transCurr').value, outbound: getSegs('outboundSegments'), inbound: type === 'round-trip' ? getSegs('inboundSegments') : [] }; const t = appData.trips.find(x => x.id === currentState.tripId); const d = t.days.find(x => x.id === currentState.dayId); d.transport.push(newItem); saveData(); closeModals(); render(); }
        function deleteTransport(id) { if(!confirm("Remover?")) return; const t = appData.trips.find(x => x.id === currentState.tripId); const d = t.days.find(x => x.id === currentState.dayId); d.transport = d.transport.filter(x => x.id !== id); saveData(); render(); }
        function renderTimeline(segs, label) { if(!segs || !segs.length) return ''; return `<div class="mb-2"><span class="font-bold text-[10px] text-gray-500">${label}</span>` + segs.map(s => `<div class="timeline-item"><div class="timeline-dot"></div> ${s.time} ${s.from} ‚ûù ${s.to} <small>(${s.method})</small></div>`).join('') + `</div>`; }
        function openCitySearch() { document.getElementById('cityModal').classList.add('active'); document.getElementById('cityList').innerHTML=''; document.getElementById('citySearchInput').value=''; }
        function searchCity() { const query = document.getElementById('citySearchInput').value; if(!query) return; fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=10&language=pt&format=json`).then(res => res.json()).then(data => { const list = document.getElementById('cityList'); list.innerHTML = ''; if(data.results) { data.results.forEach(city => { const div = document.createElement('div'); div.className = "p-3 border-b hover:bg-blue-50 cursor-pointer flex justify-between items-center"; div.innerHTML = `<span><b>${city.name}</b> <small>(${city.country_code})</small></span>`; div.onclick = () => addLocation(city); list.appendChild(div); }); } else alert("N√£o encontrado!"); }); }
        function addLocation(cityData) { const t = appData.trips.find(x => x.id === currentState.tripId); const d = t.days.find(x => x.id === currentState.dayId); d.locations.push({ id: Math.random().toString(36).substr(2, 9), name: `${cityData.name}, ${cityData.country_code}`, lat: cityData.latitude, lng: cityData.longitude }); saveData(); closeModals(); render(); }
        function deleteLocation(idx) { const t = appData.trips.find(x => x.id === currentState.tripId); const d = t.days.find(x => x.id === currentState.dayId); d.locations.splice(idx, 1); saveData(); render(); }
        async function fetchWeather(lat, lng, date, elId) { const box = document.getElementById(elId); if(!box) return; try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&start_date=${date}&end_date=${date}`); const data = await res.json(); if(data.daily) box.innerHTML = `üå§ ${Math.round(data.daily.temperature_2m_min[0])}¬∞ / ${Math.round(data.daily.temperature_2m_max[0])}¬∞C`; } catch(e) { box.innerHTML = "-"; } }
        function createTrip() { const n = document.getElementById('newName').value; const ds = document.getElementById('newDest').value; const s = document.getElementById('newStart').value; const e = document.getElementById('newEnd').value; if(!ds || !s || !e) return alert("Preencha tudo!"); const nt = { id: Math.random().toString(36).substr(2, 9), name: n, destination: ds, startDate: s, endDate: e, days: [], initialCosts: [] }; const count = (new Date(e) - new Date(s)) / 86400000 + 1; for(let i=0; i<count; i++) { const cur = new Date(s); cur.setDate(cur.getDate() + i); nt.days.push({ id: Math.random().toString(36).substr(2, 9), date: cur.toISOString().split('T')[0], attractions: [], transport: [], extraCosts: [], locations: [], journal: '' }); } appData.trips.push(nt); saveData(); goTo('home'); }
        function exportData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData)); a.download = "backup_viagem.json"; a.click(); }
        function importData(e) { const r = new FileReader(); r.onload = ev => { if(confirm("Substituir?")) { appData = JSON.parse(ev.target.result); saveData(); location.reload(); } }; r.readAsText(e.target.files[0]); }
        function goTo(p) { currentState.page = p; render(); }
        function openTrip(id) { currentState.tripId = id; goTo('trip'); }
        function openDay(tid, did) { currentState.tripId = tid; currentState.dayId = did; goTo('day'); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
        function hardReset() { if(confirm("Apagar tudo?")) { localStorage.clear(); location.reload(); } }
        function formatDateBr(d) { if(!d) return ''; const p = d.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
        function deleteTrip(id) { if(confirm("Apagar?")) { appData.trips = appData.trips.filter(t => t.id !== id); saveData(); render(); } }
        function resetCity() { const t = appData.trips.find(x => x.id === currentState.tripId); const d = t.days.find(x => x.id === currentState.dayId); d.city = null; d.lat = null; d.lng = null; saveData(); render(); }
        function deleteAttraction(aid) { if(confirm("Apagar?")) { const t = appData.trips.find(x => x.id === currentState.tripId); const d = t.days.find(x => x.id === currentState.dayId); d.attractions = d.attractions.filter(a => a.id !== aid); saveData(); render(); } }
        function toggleVisited(aid) { const t = appData.trips.find(x => x.id === currentState.tripId); const d = t.days.find(x => x.id === currentState.dayId); const a = d.attractions.find(x => x.id === aid); a.visited = !a.visited; saveData(); render(); }
        // FUN√á√ïES NOVAS
        function openChecklist() { const t = appData.trips.find(x => x.id === currentState.tripId); const list = document.getElementById('checklistContainer'); list.innerHTML = t.checklist.map((item, i) => `<li class="flex justify-between bg-gray-50 p-2 rounded"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleCheckItem(${i})"><span class="${item.done ? 'line-through text-gray-400' : ''}">${item.text}</span></label><button onclick="deleteCheckItem(${i})" class="text-red-400 hover:text-red-600">√ó</button></li>`).join(''); document.getElementById('checklistModal').classList.add('active'); }
        function addCheckItem(e) { e.preventDefault(); const input = document.getElementById('checkInput'); if(!input.value) return; const t = appData.trips.find(x => x.id === currentState.tripId); t.checklist.push({ text: input.value, done: false }); saveData(); input.value = ''; openChecklist(); }
        function toggleCheckItem(i) { const t = appData.trips.find(x => x.id === currentState.tripId); t.checklist[i].done = !t.checklist[i].done; saveData(); openChecklist(); }
        function deleteCheckItem(i) { const t = appData.trips.find(x => x.id === currentState.tripId); t.checklist.splice(i, 1); saveData(); openChecklist(); }
        function openFinanceModal() { const t = appData.trips.find(x => x.id === currentState.tripId); if(t.rates) { document.getElementById('rateUSD').value = t.rates.USD || ''; document.getElementById('rateEUR').value = t.rates.EUR || ''; document.getElementById('rateGBP').value = t.rates.GBP || ''; } document.getElementById('financeModal').classList.add('active'); switchFinanceTab('report'); renderInitialCosts(); }
        function saveRates() { const t = appData.trips.find(x => x.id === currentState.tripId); t.rates = { USD: parseFloat(document.getElementById('rateUSD').value) || 0, EUR: parseFloat(document.getElementById('rateEUR').value) || 0, GBP: parseFloat(document.getElementById('rateGBP').value) || 0 }; saveData(); renderReport(); }
        function renderReport() { const t = appData.trips.find(x => x.id === currentState.tripId); let sunkSums = { BRL:0, USD:0, EUR:0, GBP:0 }; let predicted = { BRL:0, USD:0, EUR:0, GBP:0 }; let actual = { BRL:0, USD:0, EUR:0, GBP:0 }; t.initialCosts.forEach(c => sunkSums[c.currency] += c.value); t.days.forEach(d => { d.transport.forEach(tr => { if(tr.cost && tr.currency) { let val = parseFloat(tr.cost); predicted[tr.currency] += val; actual[tr.currency] += val; } }); d.extraCosts.forEach(ex => { predicted[ex.currency] += ex.value; actual[ex.currency] += ex.value; }); d.attractions.forEach(a => { (a.costs || []).forEach(c => { let val = parseFloat(c.value); predicted[c.currency] += val; if(a.visited) actual[c.currency] += val; }); }); }); let sunkHtml = ''; ['BRL', 'USD', 'EUR', 'GBP'].forEach(c => { if(sunkSums[c] > 0) sunkHtml += `<div class="bg-blue-100 p-2 rounded text-center"><small class="block font-bold">${c}</small>${sunkSums[c].toFixed(2)}</div>`; }); document.getElementById('reportSunkCosts').innerHTML = sunkHtml || '<span class="text-gray-400 text-xs italic col-span-4 text-center">Nenhum custo fixo lan√ßado.</span>'; let html = `<table class="w-full text-left border-collapse"><thead><tr class="bg-gray-100 border-b-2 border-gray-300"><th class="p-2">Moeda</th><th class="p-2 text-blue-800">Previsto</th><th class="p-2 text-green-800">Realizado</th><th class="p-2 text-gray-600">Saldo</th></tr></thead><tbody>`; ['BRL', 'USD', 'EUR', 'GBP'].forEach(curr => { if(predicted[curr] > 0 || actual[curr] > 0) { let diff = predicted[curr] - actual[curr]; html += `<tr class="border-b hover:bg-gray-50"><td class="p-3 font-bold">${curr}</td><td class="p-3 text-blue-700 font-mono">${predicted[curr].toFixed(2)}</td><td class="p-3 text-green-700 font-mono">${actual[curr].toFixed(2)}</td><td class="p-3 font-mono ${diff >= 0 ? 'text-green-600 font-bold' : 'text-red-500 font-bold'}">${diff.toFixed(2)}</td></tr>`; } }); html += `</tbody></table>`; if(!Object.values(predicted).some(v=>v>0)) html = `<p class="text-center text-gray-400 p-4">Nenhum custo vari√°vel lan√ßado.</p>`; document.getElementById('reportTable').innerHTML = html; const rates = t.rates || { USD: 0, EUR: 0, GBP: 0 }; let grandTotalBRL = (sunkSums.BRL + predicted.BRL) + (sunkSums.USD + predicted.USD) * (rates.USD || 0) + (sunkSums.EUR + predicted.EUR) * (rates.EUR || 0) + (sunkSums.GBP + predicted.GBP) * (rates.GBP || 0); if(grandTotalBRL > 0) { document.getElementById('reportGrandTotal').innerHTML = `Custo Total Estimado da Viagem: R$ ${grandTotalBRL.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`; } else { document.getElementById('reportGrandTotal').innerHTML = ""; } }
        function generatePDF() { const t = appData.trips.find(x => x.id === currentState.tripId); const content = document.createElement('div'); content.style.padding = "20px"; content.style.fontFamily = "sans-serif"; let html = `<h1 style="text-align:center; color:#1e3a8a">${t.destination}</h1><h3 style="text-align:center; color:#555">${t.startDate} a ${t.endDate}</h3><hr>`; t.days.forEach((d, i) => { const title = d.customTitle || `Dia ${i+1}`; html += `<div style="page-break-inside: avoid; margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 8px;"><h4 style="margin:0; color:#1e3a8a; background:#eee; padding:5px">${title} - ${formatDateBr(d.date)}</h4>`; if(d.locations.length) html += `<p style="font-size:12px">üìç ${d.locations.map(l=>l.name).join(' & ')}</p>`; if(d.transport.length) html += `<p style="font-size:12px">üöÇ <b>Transporte:</b> ${d.transport.length} trechos</p>`; html += `<ul style="font-size:12px; padding-left:20px">`; if(d.attractions.length === 0) html += `<li>Livre</li>`; d.attractions.forEach(a => { html += `<li><b>${a.name}</b> ${a.hours ? `(${a.hours})` : ''}</li>`; }); html += `</ul></div>`; }); content.innerHTML = html; html2pdf().set({ margin: 10, filename: `Roteiro_${t.destination}.pdf` }).from(content).save(); }

        init();
    </script>
</body>
</html>